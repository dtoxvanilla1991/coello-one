#!/usr/bin/env sh
set -euo pipefail

REPO_ROOT="$(dirname "$0")/.."
cd "${REPO_ROOT}" || exit 1

if ! command -v bunx >/dev/null 2>&1; then
  echo "[pre-commit] bunx is required. Install root dev dependencies with 'bun install'." >&2
  exit 1
fi

bunx --bun lint-staged

FRONTEND_CHANGED=$(git diff --cached --name-only --diff-filter=ACMRTUXB -- 'coello-one/**')
if [ -n "$FRONTEND_CHANGED" ]; then
  echo "[pre-commit] Checking frontend formatting (Prettier)" >&2
  (cd coello-one && bun run format)
fi

PY_CHANGED=$(git diff --cached --name-only --diff-filter=ACMRTUXB -- 'flask-server/**/*.py')
if [ -n "$PY_CHANGED" ]; then
  if ! command -v make >/dev/null 2>&1; then
    echo "[pre-commit] make is required to run backend lint fixes." >&2
    exit 1
  fi

  make backend-lint-fix

  echo "[pre-commit] Checking backend formatting (Black, staged files)" >&2
  (cd flask-server \
    && (test -x ../.venv/bin/python || make install) \
    && printf '%s\n' "$PY_CHANGED" \
      | sed 's|^flask-server/||' \
      | tr '\n' '\0' \
      | xargs -0 ../.venv/bin/python -m black --check)
fi
